name: Release

on:
  workflow_dispatch:
    inputs:
      release_channel:
        description: "Release channel"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
  push:
    tags: ["v*"]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/ratmas-bot

jobs:
  staging:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.release_channel == 'staging' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ratmas-bot/package-lock.json

      - name: Build dist
        working-directory: ratmas-bot
        run: |
          npm ci
          npm run build
          tar -czf ../ratmas-bot-dist.tar.gz dist/

      - name: Create pre-release (staging)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: staging-${{ github.run_number }}
          name: Staging ${{ github.run_number }}
          prerelease: true
          draft: false
          files: |
            ratmas-bot-dist.tar.gz

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push staging image
        uses: docker/build-push-action@v5
        with:
          context: ./ratmas-bot
          file: ./ratmas-bot/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:staging

  production:
    if: ${{ github.event_name == 'push' && startsWith(github.ref_name, 'v') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ratmas-bot/package-lock.json

      - name: Build dist
        working-directory: ratmas-bot
        run: |
          npm ci
          npm run build
          tar -czf ../ratmas-bot-dist.tar.gz dist/

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          prerelease: false
          draft: false
          files: |
            ratmas-bot-dist.tar.gz

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push production image
        uses: docker/build-push-action@v5
        with:
          context: ./ratmas-bot
          file: ./ratmas-bot/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
